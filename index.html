<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Conversacional - Fiscal√≠a General de la Naci√≥n</title>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .avatar-section {
            flex: 2;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .controls-section {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            height: fit-content;
        }

        .avatar-display {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            background: linear-gradient(45deg, #2c3e50, #34495e);
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .avatar-icon {
            font-size: 8em;
            opacity: 0.7;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .avatar-speaking {
            animation: pulse 0.5s infinite alternate;
        }

        .avatar-text {
            font-size: 1.5em;
            text-align: center;
            padding: 0 20px;
            font-weight: bold;
        }

        .sound-bars {
            display: flex;
            gap: 5px;
            margin: 20px 0;
        }

        .sound-bar {
            width: 6px;
            height: 30px;
            background: #3498db;
            border-radius: 3px;
            animation: soundWave 1s infinite ease-in-out;
        }

        .sound-bar:nth-child(2) { animation-delay: 0.1s; }
        .sound-bar:nth-child(3) { animation-delay: 0.2s; }
        .sound-bar:nth-child(4) { animation-delay: 0.3s; }
        .sound-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes soundWave {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            color: white;
            padding: 15px 30px;
            margin: 10px 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(238, 90, 82, 0.3);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 90, 82, 0.4);
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            border-left: 4px solid #4CAF50;
            font-weight: bold;
        }

        .error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }

        .input-group input::placeholder, .input-group textarea::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .conversation-log {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
        }

        .conversation-item {
            margin: 8px 0;
            padding: 8px;
            border-radius: 5px;
        }

        .user-message {
            background: rgba(0,123,255,0.3);
            border-left: 3px solid #007bff;
        }

        .avatar-message {
            background: rgba(40,167,69,0.3);
            border-left: 3px solid #28a745;
        }

        .system-message {
            background: rgba(108,117,125,0.3);
            border-left: 3px solid #6c757d;
            font-style: italic;
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            margin-top: auto;
        }

        .mic-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            font-size: 18px;
        }

        .mic-button.recording {
            background: linear-gradient(45deg, #dc3545, #c82333);
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è Fiscal√≠a General de la Naci√≥n</h1>
        <p>Estrategia de Transformaci√≥n Digital - Asistente Virtual Inteligente</p>
    </div>

    <div class="container">
        <div class="avatar-section">
            <h2>ü§ñ Asistente Virtual</h2>
            <div class="avatar-display" id="avatarDisplay">
                <div class="avatar-icon" id="avatarIcon">üë®‚Äçüíº</div>
                <div class="sound-bars" id="soundBars" style="display: none;">
                    <div class="sound-bar"></div>
                    <div class="sound-bar"></div>
                    <div class="sound-bar"></div>
                    <div class="sound-bar"></div>
                    <div class="sound-bar"></div>
                </div>
                <div class="avatar-text" id="avatarText">Especialista en Transformaci√≥n Digital</div>
            </div>
            <div id="status" class="status">Sistema listo. Presione 'Iniciar Sesi√≥n' para comenzar</div>
        </div>

        <div class="controls-section">
            <h3>‚öôÔ∏è Controles</h3>
            
            <button id="startSession" class="button">üöÄ Iniciar Sesi√≥n</button>
            <button id="stopSession" class="button" disabled>‚èπÔ∏è Detener Sesi√≥n</button>
            
            <div class="input-group">
                <label for="userInput">üí¨ Escribir Pregunta:</label>
                <textarea id="userInput" rows="3" placeholder="Ejemplo: ¬øCu√°les son los pilares de la transformaci√≥n digital en la justicia?"></textarea>
                <button id="sendText" class="button" disabled>üì§ Enviar Texto</button>
            </div>

            <div class="input-group">
                <button id="startListening" class="button mic-button" disabled>üé§ Hablar</button>
                <button id="stopListening" class="button" disabled>‚èπÔ∏è Parar Audio</button>
            </div>

            <div class="conversation-log" id="conversationLog">
                <div class="conversation-item system-message">
                    <strong>Sistema:</strong> Esperando inicializaci√≥n...
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>¬© 2025 Fiscal√≠a General de la Naci√≥n - Transformaci√≥n Digital</p>
    </div>

    <script>
        // Configuraci√≥n Azure
        const config = {
            cogSvcSubKey: "1de1c139475db9fb1f4c4abfdf578a0",
            azureOpenAIEndpoint: "https://fgnfoundrylabo3874907599.openai.azure.com/",
            azureOpenAIApiKey: "1oSTnxg0CC9O4oIaB2a6POpWSvOIFxXP6qwR5QlgbDW2ve79fE7KJQQJ99BCACHYHv6XJ3w3AAAAACOGNk1S",
            azureOpenAIDeploymentName: "gpt-4.1",
            azureOpenAIApiVersion: "2024-02-15-preview",
            systemPrompt: "Eres un asistente experto en transformaci√≥n digital para la Fiscal√≠a General de la Naci√≥n de Colombia. Respondes preguntas sobre digitalizaci√≥n, modernizaci√≥n tecnol√≥gica, procesos judiciales digitales, inteligencia artificial en la justicia, ciberseguridad jur√≠dica, y estrategias de transformaci√≥n digital institucional. Siempre respondes en espa√±ol colombiano, de manera formal pero accesible, sin emojis ni caracteres especiales, solo texto. Tus respuestas son precisas, informativas y orientadas a la transformaci√≥n digital del sistema judicial. Mantienes un tono profesional y conocedor del contexto legal colombiano.",
            sttlocales: "es-CO",
            ttsVoice: "es-CO-SalomeNeural",
            region: "eastus2"
        };

        let speechSynthesizer;
        let speechRecognizer;
        let isSessionActive = false;
        let isListening = false;
        let isSpeaking = false;

        // Elementos DOM
        const startSessionBtn = document.getElementById('startSession');
        const stopSessionBtn = document.getElementById('stopSession');
        const sendTextBtn = document.getElementById('sendText');
        const startListeningBtn = document.getElementById('startListening');
        const stopListeningBtn = document.getElementById('stopListening');
        const userInput = document.getElementById('userInput');
        const statusDiv = document.getElementById('status');
        const conversationLog = document.getElementById('conversationLog');
        const avatarDisplay = document.getElementById('avatarDisplay');
        const avatarIcon = document.getElementById('avatarIcon');
        const avatarText = document.getElementById('avatarText');
        const soundBars = document.getElementById('soundBars');

        // Funciones de utilidad
        function updateStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'status error' : 'status';
            console.log(message);
        }

        function addToConversation(speaker, message) {
            const item = document.createElement('div');
            const className = speaker === 'Usuario' ? 'user-message' : 
                             speaker === 'Sistema' ? 'system-message' : 'avatar-message';
            item.className = `conversation-item ${className}`;
            item.innerHTML = `<strong>${speaker}:</strong> ${message}`;
            conversationLog.appendChild(item);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        function updateAvatarState(state, message = '') {
            switch(state) {
                case 'idle':
                    avatarIcon.className = 'avatar-icon';
                    avatarIcon.textContent = 'üë®‚Äçüíº';
                    avatarText.textContent = 'Esperando pregunta...';
                    soundBars.style.display = 'none';
                    break;
                case 'listening':
                    avatarIcon.className = 'avatar-icon avatar-speaking';
                    avatarIcon.textContent = 'üëÇ';
                    avatarText.textContent = 'Escuchando...';
                    soundBars.style.display = 'flex';
                    break;
                case 'thinking':
                    avatarIcon.className = 'avatar-icon';
                    avatarIcon.textContent = 'ü§î';
                    avatarText.textContent = 'Procesando...';
                    soundBars.style.display = 'none';
                    break;
                case 'speaking':
                    avatarIcon.className = 'avatar-icon avatar-speaking';
                    avatarIcon.textContent = 'üó£Ô∏è';
                    avatarText.textContent = 'Respondiendo...';
                    soundBars.style.display = 'flex';
                    break;
            }
        }

        // Inicializar Azure Speech SDK
        async function initializeSpeech() {
            try {
                updateStatus("Inicializando servicios de voz...");

                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.cogSvcSubKey, config.region);
                
                // Configurar s√≠ntesis de voz
                speechConfig.speechSynthesisVoiceName = config.ttsVoice;
                speechSynthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);

                // Configurar reconocimiento de voz
                speechConfig.speechRecognitionLanguage = config.sttlocales;
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                speechRecognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

                speechRecognizer.recognized = async (s, e) => {
                    if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && e.result.text.trim()) {
                        const userText = e.result.text.trim();
                        updateAvatarState('thinking');
                        addToConversation('Usuario', userText);
                        await processUserInput(userText);
                    }
                };

                speechRecognizer.recognizing = (s, e) => {
                    if (e.result.text.trim()) {
                        avatarText.textContent = `Escuchando: "${e.result.text}"`;
                    }
                };

                updateStatus("Servicios de voz inicializados");
                return true;
            } catch (error) {
                updateStatus(`Error al inicializar voz: ${error.message}`, true);
                return false;
            }
        }

        // Obtener respuesta de OpenAI
        async function getOpenAIResponse(userMessage) {
            try {
                const response = await fetch(`${config.azureOpenAIEndpoint}openai/deployments/${config.azureOpenAIDeploymentName}/chat/completions?api-version=${config.azureOpenAIApiVersion}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.azureOpenAIApiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: config.systemPrompt },
                            { role: "user", content: userMessage }
                        ],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Error OpenAI:', error);
                return "Disculpe, hay un problema t√©cnico con el servicio de inteligencia artificial. Por favor intente nuevamente en un momento.";
            }
        }

        // S√≠ntesis de voz
        async function speakText(text) {
            return new Promise((resolve, reject) => {
                try {
                    updateAvatarState('speaking');
                    isSpeaking = true;
                    
                    speechSynthesizer.speakTextAsync(
                        text,
                        (result) => {
                            isSpeaking = false;
                            if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                                updateAvatarState('idle');
                                resolve();
                            } else {
                                updateAvatarState('idle');
                                reject(new Error("Error en s√≠ntesis de voz"));
                            }
                        },
                        (error) => {
                            isSpeaking = false;
                            updateAvatarState('idle');
                            reject(error);
                        }
                    );
                } catch (error) {
                    isSpeaking = false;
                    updateAvatarState('idle');
                    reject(error);
                }
            });
        }

        // Procesar entrada del usuario
        async function processUserInput(userText) {
            try {
                updateStatus("Generando respuesta...");
                
                const response = await getOpenAIResponse(userText);
                addToConversation('Asistente', response);
                
                // Intentar s√≠ntesis de voz
                try {
                    await speakText(response);
                    updateStatus("Listo para la siguiente pregunta");
                } catch (voiceError) {
                    console.log("Voice synthesis failed:", voiceError);
                    updateStatus("Respuesta lista (audio no disponible)");
                    updateAvatarState('idle');
                }
            } catch (error) {
                updateStatus(`Error: ${error.message}`, true);
                updateAvatarState('idle');
            }
        }

        // Iniciar sesi√≥n
        async function startSession() {
            try {
                updateStatus("Iniciando sesi√≥n...");
                
                // Habilitar controles inmediatamente
                isSessionActive = true;
                startSessionBtn.disabled = true;
                stopSessionBtn.disabled = false;
                sendTextBtn.disabled = false;
                
                updateAvatarState('idle');
                updateStatus("Sesi√≥n activa - Sistema listo");
                addToConversation('Sistema', '¬°Hola! Soy su asistente virtual especializado en Transformaci√≥n Digital para la Fiscal√≠a General de la Naci√≥n. Puedo responder preguntas sobre digitalizaci√≥n, modernizaci√≥n tecnol√≥gica, procesos judiciales digitales y estrategias de transformaci√≥n institucional. ¬øEn qu√© puedo ayudarle?');
                
                // Inicializar servicios de voz en paralelo
                const voiceInitialized = await initializeSpeech();
                if (voiceInitialized) {
                    startListeningBtn.disabled = false;
                    updateStatus("Sistema completo activo - Texto y voz disponibles");
                    addToConversation('Sistema', 'Servicios de voz activados. Puede hablar o escribir sus preguntas.');
                } else {
                    updateStatus("Sistema activo en modo texto");
                }
            } catch (error) {
                updateStatus(`Error al iniciar: ${error.message}`, true);
            }
        }

        // Detener sesi√≥n
        function stopSession() {
            try {
                if (speechSynthesizer && isSpeaking) {
                    speechSynthesizer.close();
                }
                if (speechRecognizer && isListening) {
                    speechRecognizer.stopContinuousRecognitionAsync();
                }
                
                isSessionActive = false;
                isListening = false;
                isSpeaking = false;
                
                // Actualizar controles
                startSessionBtn.disabled = false;
                stopSessionBtn.disabled = true;
                sendTextBtn.disabled = true;
                startListeningBtn.disabled = true;
                stopListeningBtn.disabled = true;
                
                updateAvatarState('idle');
                avatarIcon.textContent = 'üë®‚Äçüíº';
                avatarText.textContent = 'Sesi√≥n finalizada';
                
                updateStatus("Sesi√≥n detenida");
                addToConversation('Sistema', 'Sesi√≥n finalizada. Gracias por usar el asistente virtual de la Fiscal√≠a General.');
            } catch (error) {
                updateStatus(`Error al detener: ${error.message}`, true);
            }
        }

        // Event listeners
        startSessionBtn.addEventListener('click', startSession);
        stopSessionBtn.addEventListener('click', stopSession);

        sendTextBtn.addEventListener('click', async () => {
            const text = userInput.value.trim();
            if (text && isSessionActive) {
                userInput.value = '';
                addToConversation('Usuario', text);
                await processUserInput(text);
            }
        });

        userInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey && isSessionActive) {
                e.preventDefault();
                const text = userInput.value.trim();
                if (text) {
                    userInput.value = '';
                    addToConversation('Usuario', text);
                    await processUserInput(text);
                }
            }
        });

        startListeningBtn.addEventListener('click', () => {
            if (isSessionActive && !isListening && speechRecognizer) {
                speechRecognizer.startContinuousRecognitionAsync();
                isListening = true;
                startListeningBtn.disabled = true;
                startListeningBtn.classList.add('recording');
                stopListeningBtn.disabled = false;
                updateAvatarState('listening');
                updateStatus("Escuchando... Puede hablar ahora");
            }
        });

        stopListeningBtn.addEventListener('click', () => {
            if (isListening && speechRecognizer) {
                speechRecognizer.stopContinuousRecognitionAsync();
                isListening = false;
                startListeningBtn.disabled = false;
                startListeningBtn.classList.remove('recording');
                stopListeningBtn.disabled = true;
                updateAvatarState('idle');
                updateStatus("Micr√≥fono desactivado");
            }
        });

        // Inicializaci√≥n
        updateStatus("Sistema listo. Presione 'Iniciar Sesi√≥n' para comenzar");
    </script>
</body>
</html>
