<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Avatar Virtual - Fiscalía General de la Nación</title>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003f7f 0%, #0056b3 100%);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #ffd700;
            flex-shrink: 0;
        }

        .header-content {
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        .header h1 {
            font-size: 3.2em;
            margin: 0;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: bold;
            letter-spacing: 3px;
        }

        .header .tagline {
            font-size: 1.1em;
            color: #ffd700;
            font-style: italic;
            font-weight: 500;
            margin: 0;
        }

        .main-container {
            display: flex;
            flex: 1;
            padding: 15px;
            gap: 15px;
            min-height: 0;
        }

        .avatar-section {
            flex: 3.5;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #videoContainer {
            width: 100%;
            height: calc(100% - 120px);
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            min-height: 550px;
        }

        #remoteVideo video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 13px;
        }

        .control-panel {
            height: 120px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .document-section {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .upload-zone {
            border: 2px dashed rgba(255,215,0,0.5);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 10px;
        }

        .upload-zone:hover {
            background: rgba(255,215,0,0.1);
            border-color: #ffd700;
        }

        .upload-zone.dragover {
            background: rgba(255,215,0,0.2);
            border-color: #ffed4a;
        }

        .document-list {
            max-height: 60px;
            overflow-y: auto;
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            margin: 2px 0;
            font-size: 9px;
        }

        .document-name {
            flex: 1;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .document-status {
            font-size: 8px;
            color: #4CAF50;
            margin-left: 5px;
        }

        .button.documents {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }

        .button.documents:hover:not(:disabled) {
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        /* Modal para gestión de documentos */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #003f7f 0%, #0056b3 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 2px solid #ffd700;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 1.5em;
            color: white;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            color: #ffd700;
            font-size: 2em;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: white;
        }

        .upload-area {
            border: 3px dashed #ffd700;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
        }

        .upload-area:hover, .upload-area.dragover {
            background: rgba(255,215,0,0.1);
            border-color: #ffed4a;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .upload-text {
            font-size: 1.2em;
            color: white;
            margin-bottom: 10px;
        }

        .upload-subtitle {
            font-size: 0.9em;
            color: rgba(255,255,255,0.7);
        }

        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .document-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .document-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .document-icon {
            font-size: 2em;
            color: #ffd700;
        }

        .document-actions {
            display: flex;
            gap: 5px;
        }

        .doc-action-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s;
        }

        .doc-action-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .doc-action-btn.remove {
            background: rgba(244, 67, 54, 0.3);
        }

        .doc-action-btn.remove:hover {
            background: rgba(244, 67, 54, 0.5);
        }

        .document-name {
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .document-info {
            font-size: 0.8em;
            color: rgba(255,255,255,0.7);
            margin-bottom: 8px;
        }

        .document-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .status-processed {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }

        .status-processing {
            background: rgba(255, 152, 0, 0.3);
            color: #FF9800;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }

        .summary-stats {
            color: rgba(255,255,255,0.8);
            font-size: 0.9em;
        }

        .controls-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
            min-width: 300px;
        }

        .transcription-box, .response-box {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .transcription-box h3, .response-box h3 {
            margin-bottom: 8px;
            color: #ffd700;
            font-size: 0.85em;
            font-weight: bold;
        }

        .response-box h3 {
            color: #87CEEB;
        }

        textarea {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 8px;
            color: white;
            font-size: 11px;
            font-family: 'Segoe UI', sans-serif;
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }

        textarea::placeholder {
            color: rgba(255,255,255,0.6);
        }

        textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .button {
            background: linear-gradient(45deg, #0056b3, #003f7f);
            border: none;
            color: white;
            padding: 6px 10px;
            margin: 1px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 1px 6px rgba(0, 86, 179, 0.3);
            white-space: nowrap;
            min-width: fit-content;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 86, 179, 0.4);
            background: linear-gradient(45deg, #0066cc, #004499);
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button.stop {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 3px 12px rgba(244, 67, 54, 0.3);
        }

        .button.stop:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .button.question {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            box-shadow: 0 3px 12px rgba(33, 150, 243, 0.3);
        }

        .button.question:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .status {
            padding: 4px;
            margin: 2px 0;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            border-left: 2px solid #ffd700;
            font-weight: bold;
            font-size: 9px;
            text-align: center;
        }

        .status.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .status.listening {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .wake-word-info {
            background: rgba(255,255,255,0.05);
            padding: 6px;
            border-radius: 4px;
            margin: 2px 0;
            text-align: center;
            font-size: 9px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .wake-word-highlight {
            color: #ffd700;
            font-weight: bold;
            font-size: 13px;
        }

        .listening-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .footer {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            font-size: 11px;
            opacity: 0.8;
            flex-shrink: 0;
        }

        .button-row {
            display: flex;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .word-count {
            font-size: 10px;
            color: rgba(255,255,255,0.7);
            text-align: right;
            margin-top: 4px;
        }

        /* Responsivo para pantallas más pequeñas */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .avatar-section {
                flex: 2;
                min-height: 400px;
            }
            
            .controls-section {
                flex: 1;
                flex-direction: row;
                max-width: none;
                min-height: 120px;
            }
            
            #videoContainer {
                height: calc(100% - 100px);
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Luz</h1>
            <p class="tagline">"La Justicia se ilumina con Inteligencia Artificial"</p>
        </div>
    </div>

    <div class="main-container">
        <!-- Sección Avatar (Ocupa 80% del espacio) -->
        <div class="avatar-section">
            <div id="videoContainer">
                <div id="remoteVideo"></div>
                <canvas id="canvas" width="1920" height="1080" hidden></canvas>
                <canvas id="tmpCanvas" width="1920" height="1080" hidden></canvas>
            </div>
            
            <div class="control-panel">
                <div class="button-row">
                    <button id="startSession" class="button">🚀 Iniciar</button>
                    <button id="stopSession" class="button stop" disabled>⏹️ Parar</button>
                    <button id="askQuestion" class="button question" disabled>❓ Pregunta</button>
                    <button id="generateExplanation" class="button explanation" disabled>💡 Explica</button>
                    <button id="documentsBtn" class="button documents">📄 Documentos</button>
                </div>
                
                <div class="wake-word-info">
                    <div>🎤 <span class="wake-word-highlight">Comandos disponibles</span></div>
                    <small><strong>"Luz"</strong> = Pregunta • <strong>"Toc toc"</strong> = Explicación • <strong>"Analiza"</strong> = Documento</small>
                </div>
                
                <div id="status" class="status">Sistema listo. Presione 'Iniciar Avatar' para comenzar</div>
            </div>
        </div>

        <!-- Sección Transcripción y Respuesta (Compacta - 20%) -->
        <div class="controls-section">
            <div class="transcription-box">
                <h3><span id="listeningIndicator"></span>📝 Transcripción Completa</h3>
                <textarea id="transcription" readonly placeholder="Aquí se guardará todo lo que diga durante la presentación..."></textarea>
                <div id="wordCount" class="word-count">0 palabras</div>
            </div>

            <div class="response-box">
                <h3>🤖 Pregunta/Respuesta IA</h3>
                <textarea id="avatarResponse" readonly placeholder="El avatar generará preguntas inteligentes sobre su presentación..."></textarea>
            </div>
        </div>
    </div>

    <!-- Modal para gestión de documentos -->
    <div id="documentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📄 Gestión de Documentos</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" multiple accept=".pdf,.txt" hidden>
                <div class="upload-icon">📁</div>
                <div class="upload-text">Arrastra archivos aquí o haz clic para seleccionar</div>
                <div class="upload-subtitle">Archivos soportados: PDF, TXT (máx. 10MB cada uno)</div>
            </div>
            
            <div class="documents-grid" id="documentsGrid">
                <!-- Los documentos aparecerán aquí -->
            </div>
            
            <div class="modal-footer">
                <div class="summary-stats" id="summaryStats">
                    No hay documentos cargados
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>© 2025 Fiscalía General de la Nación - IA Conversacional Avanzada</p>
    </div>

    <script>
        // Configuración
        const config = {
            cogSvcSubKey: "1de1c13947f34b9fb1f4c4abfdf578a0",
            azureOpenAIEndpoint: "https://fgnfoundrylabo3874907599.openai.azure.com/",
            azureOpenAIApiKey: "1oSTnxg0CC9O4oIaB2a6POpWSvOIFxXP6qwR5QlgbDW2ve79fE7KJQQJ99BCACHYHv6XJ3w3AAAAACOGNk1S",
            azureOpenAIDeploymentName: "gpt-4.1",
            azureOpenAIApiVersion: "2024-02-15-preview",
            systemPrompt: `Eres un asistente IA especializado que escucha presentaciones sobre la Estrategia de Transformación Digital de la Fiscalía General de la Nación de Colombia.

TU FUNCIÓN PRINCIPAL:
- Analizar el contenido transcrito de la presentación de la Fiscal
- Generar preguntas inteligentes, relevantes y profesionales sobre lo expuesto (comando "Luz")
- Proporcionar explicaciones detalladas y profundizaciones sobre temas específicos (comando "Toc toc")
- Analizar documentos PDF cargados y responder preguntas sobre ellos (comando "Analiza")
- Hacer preguntas que demuestren comprensión profunda del tema
- Solicitar aclaraciones sobre puntos específicos mencionados
- Explicar conceptos complejos de manera clara y accesible

CONOCIMIENTO BASE DE LA FISCALÍA:
- Direccionamiento Estratégico 2024-2028: "Experiencia e innovación al servicio de la justicia"
- 5 Pilares Estratégicos de transformación
- 6 Programas de Transformación Digital
- Proyectos clave: SPOA 2, SGDEA, expediente electrónico, laboratorio de innovación
- Marco normativo: Resolución 0412/2024

TIPOS DE RESPUESTAS SEGÚN COMANDO:

PARA "LUZ" (PREGUNTAS):
1. Preguntas de profundización: "¿Podría explicar más sobre [tema específico mencionado]?"
2. Preguntas de implementación: "¿Cómo se implementará concretamente [proyecto mencionado]?"
3. Preguntas de integración: "¿Cómo se relaciona [tema A] con [tema B] que mencionó?"
4. Preguntas de impacto: "¿Cuál será el impacto específico de [iniciativa] en los fiscales?"
5. Preguntas de cronograma: "¿Cuáles son los tiempos estimados para [proyecto]?"

PARA "TOC TOC" (EXPLICACIONES CONTEXTUALES):
1. Explicaciones técnicas: Solo sobre temas mencionados en la presentación
2. Contexto institucional: Antecedentes específicos de proyectos mencionados
3. Beneficios específicos: Ventajas concretas para la Fiscalía de temas expuestos
4. Comparaciones relevantes: Solo con sistemas anteriores mencionados
5. Implementación práctica: Pasos concretos de proyectos específicos presentados
6. IMPORTANTE: Si el tema no está relacionado con la presentación actual, declinar educadamente manteniendo el enfoque

PARA "ANALIZA" (ANÁLISIS DE DOCUMENTOS):
1. Análisis del contenido del documento más reciente cargado
2. Resumen de puntos clave del documento
3. Relación del documento con la Estrategia de Transformación Digital
4. Identificación de elementos relevantes para la Fiscalía
5. Extracción de datos específicos o estadísticas importantes

ESTILO DE RESPUESTAS:
- Formal pero conversacional
- Específicas basadas en lo realmente dicho o documentado
- Máximo 120 palabras por respuesta
- Una sola respuesta por vez
- Que demuestren escucha activa e inteligente
- Sin emojis en las respuestas

RESPONDE SOLO con la pregunta, explicación o análisis directo, sin preámbulos ni explicaciones adicionales.`,
            sttLocale: "es-CO",
            ttsVoice: "es-CO-SalomeNeural",
            avatarCharacter: "Meg",
            avatarStyle: "business",
            region: "westus2"
        };

        // Variables globales
        let avatarSynthesizer;
        let continuousRecognizer;
        let peerConnection;
        let isSessionActive = false;
        let isListening = false;
        let fullTranscription = ""; // Almacena toda la transcripción
        let lastSentenceCount = 0;
        let isProcessingQuestion = false; // Para evitar múltiples activaciones
        let loadedDocuments = []; // Almacena documentos cargados
        let documentsContent = ""; // Contenido de todos los documentos

        // Elementos DOM
        const startSessionBtn = document.getElementById('startSession');
        const stopSessionBtn = document.getElementById('stopSession');
        const askQuestionBtn = document.getElementById('askQuestion');
        const generateExplanationBtn = document.getElementById('generateExplanation');
        const statusDiv = document.getElementById('status');
        const transcriptionArea = document.getElementById('transcription');
        const responseArea = document.getElementById('avatarResponse');
        const listeningIndicator = document.getElementById('listeningIndicator');
        const wordCountDiv = document.getElementById('wordCount');

        // Funciones de utilidad
        function updateStatus(message, type = 'normal') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateListeningIndicator(isActive) {
            listeningIndicator.innerHTML = isActive ? '<span class="listening-indicator"></span>' : '';
        }

        function updateWordCount() {
            const words = fullTranscription.trim().split(/\s+/).filter(word => word.length > 0);
            wordCountDiv.textContent = `${words.length} palabras`;
        }

        // Generar pregunta inteligente basada en la transcripción
        async function generateIntelligentQuestion() {
            if (!fullTranscription.trim()) {
                return "Señora Fiscal, estoy lista para escuchar su presentación sobre la Estrategia de Transformación Digital de la Fiscalía.";
            }

            try {
                updateStatus("🧠 Analizando presentación y generando pregunta...");
                
                const response = await fetch(`${config.azureOpenAIEndpoint}openai/deployments/${config.azureOpenAIDeploymentName}/chat/completions?api-version=${config.azureOpenAIApiVersion}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.azureOpenAIApiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: config.systemPrompt },
                            { role: "user", content: `COMANDO: LUZ (generar pregunta)\n\nAnaliza esta transcripción de la presentación de la Fiscal y genera UNA pregunta inteligente y específica basada en lo que ha expuesto:\n\n"${fullTranscription}"` }
                        ],
                        max_tokens: 150,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('Error OpenAI:', error);
                return "Disculpe, Señora Fiscal, ¿podría repetir el último punto que mencionó?";
            }
        }

        // Generar análisis de documento
        async function generateDocumentAnalysis() {
            if (!documentsContent.trim()) {
                return "No hay documentos cargados para analizar. Por favor, suba un documento PDF primero.";
            }

            try {
                updateStatus("🧠 Analizando documento cargado...");
                
                const response = await fetch(`${config.azureOpenAIEndpoint}openai/deployments/${config.azureOpenAIDeploymentName}/chat/completions?api-version=${config.azureOpenAIApiVersion}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.azureOpenAIApiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: config.systemPrompt },
                            { role: "user", content: `COMANDO: ANALIZA (análisis de documento)

INSTRUCCIONES: Analiza el siguiente documento y proporciona un análisis específico relacionado con la Estrategia de Transformación Digital de la Fiscalía General de la Nación.

CONTENIDO DEL DOCUMENTO:
"${documentsContent.substring(0, 8000)}"

CONTEXTO DE LA PRESENTACIÓN ACTUAL:
"${fullTranscription}"

Proporciona un análisis conciso que relacione el documento con los temas de transformación digital de la Fiscalía.` }
                        ],
                        max_tokens: 200,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('Error OpenAI:', error);
                return "No pude analizar el documento en este momento. Por favor, intente nuevamente.";
            }
        }

        // Extraer texto de PDF
        async function extractTextFromPDF(file) {
            try {
                updateStatus("📄 Procesando PDF...");
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let fullText = '';
                const totalPages = pdf.numPages;
                
                for (let i = 1; i <= Math.min(totalPages, 20); i++) { // Limitar a 20 páginas
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                return fullText;
            } catch (error) {
                console.error('Error extrayendo texto del PDF:', error);
                throw new Error('No se pudo procesar el PDF');
            }
        }

        // Extraer texto de archivo de texto
        async function extractTextFromTXT(file) {
            try {
                return await file.text();
            } catch (error) {
                console.error('Error leyendo archivo de texto:', error);
                throw new Error('No se pudo leer el archivo de texto');
            }
        }

        // Procesar archivo subido
        async function processUploadedFile(file) {
            try {
                let content = '';
                
                if (file.type === 'application/pdf') {
                    content = await extractTextFromPDF(file);
                } else if (file.type === 'text/plain') {
                    content = await extractTextFromTXT(file);
                } else {
                    throw new Error('Tipo de archivo no soportado');
                }

                // Agregar a la base de conocimiento
                documentsContent += `\n\n=== DOCUMENTO: ${file.name} ===\n${content}`;
                
                // Agregar a la lista de documentos
                loadedDocuments.push({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    content: content,
                    processed: true
                });

                updateDocumentsGrid();
                updateStatus("✅ Documento procesado correctamente", 'normal');
            } catch (error) {
                console.error('Error procesando archivo:', error);
                updateStatus(`❌ Error: ${error.message}`, 'error');
            }
        }

        // Actualizar grid de documentos en el modal
        function updateDocumentsGrid() {
            documentsGrid.innerHTML = '';
            
            if (loadedDocuments.length === 0) {
                documentsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">No hay documentos cargados</div>';
            } else {
                loadedDocuments.forEach((doc, index) => {
                    const docCard = document.createElement('div');
                    docCard.className = 'document-card';
                    docCard.innerHTML = `
                        <div class="document-header">
                            <div class="document-icon">${doc.type === 'application/pdf' ? '📄' : '📝'}</div>
                            <div class="document-actions">
                                <button class="doc-action-btn remove" onclick="removeDocument(${index})" title="Eliminar">🗑️</button>
                            </div>
                        </div>
                        <div class="document-name">${doc.name}</div>
                        <div class="document-info">${formatFileSize(doc.size)} • ${doc.type === 'application/pdf' ? 'PDF' : 'Texto'}</div>
                        <div class="document-status ${doc.processed ? 'status-processed' : 'status-processing'}">
                            ${doc.processed ? '✓ Procesado' : '⏳ Procesando...'}
                        </div>
                    `;
                    documentsGrid.appendChild(docCard);
                });
            }
            
            updateSummaryStats();
        }

        // Actualizar estadísticas resumen
        function updateSummaryStats() {
            const totalDocs = loadedDocuments.length;
            const processedDocs = loadedDocuments.filter(doc => doc.processed).length;
            const totalSize = loadedDocuments.reduce((sum, doc) => sum + doc.size, 0);
            
            if (totalDocs === 0) {
                summaryStats.textContent = 'No hay documentos cargados';
            } else {
                summaryStats.innerHTML = `
                    <strong>${totalDocs}</strong> documento${totalDocs > 1 ? 's' : ''} cargado${totalDocs > 1 ? 's' : ''} 
                    • <strong>${processedDocs}</strong> procesado${processedDocs > 1 ? 's' : ''} 
                    • <strong>${formatFileSize(totalSize)}</strong> total
                `;
            }
        }

        // Formatear tamaño de archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Funciones del modal
        function openDocumentsModal() {
            documentsModal.style.display = 'block';
            updateDocumentsGrid();
        }

        function closeDocumentsModal() {
            documentsModal.style.display = 'none';
        }

        // Remover documento
        function removeDocument(index) {
            const removedDoc = loadedDocuments[index];
            loadedDocuments.splice(index, 1);
            
            // Reconstruir contenido de documentos
            documentsContent = '';
            loadedDocuments.forEach(doc => {
                documentsContent += `\n\n=== DOCUMENTO: ${doc.name} ===\n${doc.content}`;
            });
            
            updateDocumentsGrid();
            updateStatus(`📄 Documento removido`);
        }
        async function generateIntelligentExplanation() {
            if (!fullTranscription.trim()) {
                return "Señora Fiscal, estoy lista para proporcionar explicaciones detalladas sobre los temas que exponga en su presentación.";
            }

            try {
                updateStatus("🧠 Analizando contenido y generando explicación...");
                
                const response = await fetch(`${config.azureOpenAIEndpoint}openai/deployments/${config.azureOpenAIDeploymentName}/chat/completions?api-version=${config.azureOpenAIApiVersion}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.azureOpenAIApiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: config.systemPrompt },
                            { role: "user", content: `COMANDO: TOC TOC (generar explicación contextual)

INSTRUCCIONES ESPECÍFICAS:
- Solo explica temas que estén directamente relacionados con lo que la Fiscal ha mencionado en su presentación
- Si el último tema mencionado no está relacionado con la Estrategia de Transformación Digital de la Fiscalía, responde amablemente que prefieres mantener el foco en los temas de la presentación
- Proporciona explicaciones detalladas solo sobre temas relevantes al contexto de la reunión

Analiza esta transcripción y proporciona UNA explicación detallada sobre el tema más reciente Y relevante mencionado, o indica educadamente que prefieres mantener el enfoque en los temas de la presentación:

"${fullTranscription}"` }
                        ],
                        max_tokens: 180,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('Error OpenAI:', error);
                return "Disculpe, Señora Fiscal. Prefiero mantener nuestro enfoque en los temas específicos de la Estrategia de Transformación Digital que está presentando.";
            }
        }

        // Codificar HTML
        function htmlEncode(text) {
            const entityMap = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
                "'": '&#39;', '/': '&#x2F;'
            };
            return String(text).replace(/[&<>"'\/]/g, (match) => entityMap[match]);
        }

        // Setup WebRTC
        function setupWebRTC(iceServerUrl, iceServerUsername, iceServerCredential) {
            peerConnection = new RTCPeerConnection({
                iceServers: [{
                    urls: [iceServerUrl],
                    username: iceServerUsername,
                    credential: iceServerCredential
                }]
            });

            peerConnection.ontrack = function (event) {
                const remoteVideoDiv = document.getElementById('remoteVideo');
                for (let i = 0; i < remoteVideoDiv.childNodes.length; i++) {
                    if (remoteVideoDiv.childNodes[i].localName === event.track.kind) {
                        remoteVideoDiv.removeChild(remoteVideoDiv.childNodes[i]);
                    }
                }

                const mediaPlayer = document.createElement(event.track.kind);
                mediaPlayer.id = event.track.kind;
                mediaPlayer.srcObject = event.streams[0];
                mediaPlayer.autoplay = true;
                document.getElementById('remoteVideo').appendChild(mediaPlayer);

                if (event.track.kind === 'video') {
                    mediaPlayer.playsInline = true;
                } else {
                    mediaPlayer.muted = false;
                }
            };

            peerConnection.oniceconnectionstatechange = e => {
                if (peerConnection.iceConnectionState === 'connected') {
                    updateStatus("✅ Avatar conectado - Comenzando escucha automática");
                    
                    setTimeout(() => {
                        const welcomeMessage = "Buenos días, Señora Fiscal. Soy Luz, su asistente de inteligencia artificial especializado en Transformación Digital de la Fiscalía General de la Nación. Estoy lista para escuchar su presentación. Puede usar dos comandos: diga 'Luz' para que le haga una pregunta, o 'Toc toc' para que le proporcione una explicación detallada sobre algún tema.";
                        responseArea.value = welcomeMessage;
                        makeAvatarSpeak(welcomeMessage).then(() => {
                            startContinuousListening();
                        });
                    }, 2000);
                }

                if (peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'failed') {
                    updateStatus("❌ Conexión perdida", 'error');
                    stopSession();
                }
            };

            peerConnection.addTransceiver('video', { direction: 'sendrecv' });
            peerConnection.addTransceiver('audio', { direction: 'sendrecv' });

            avatarSynthesizer.startAvatarAsync(peerConnection).then((r) => {
                if (r.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                    updateStatus("🎤 Avatar listo - Iniciando modo escucha");
                } else {
                    updateStatus("Error al iniciar avatar", 'error');
                    startSessionBtn.disabled = false;
                }
            }).catch((error) => {
                updateStatus("Error al iniciar avatar: " + error, 'error');
                startSessionBtn.disabled = false;
            });
        }

        // Inicializar reconocimiento continuo
        function initializeContinuousRecognition() {
            try {
                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.cogSvcSubKey, config.region);
                speechConfig.speechRecognitionLanguage = config.sttLocale;
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                continuousRecognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

                // Reconocimiento en tiempo real
                continuousRecognizer.recognizing = (s, e) => {
                    if (e.result.text.trim()) {
                        // Mostrar texto temporal en transcripción
                        transcriptionArea.value = fullTranscription + "\n[Escuchando: " + e.result.text + "]";
                        transcriptionArea.scrollTop = transcriptionArea.scrollHeight;
                    }
                };

                // Reconocimiento finalizado - agregar a transcripción completa
                continuousRecognizer.recognized = async (s, e) => {
                    if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && e.result.text.trim()) {
                        const newText = e.result.text.trim();
                        console.log("Texto reconocido:", newText);
                        
                        // Verificar comandos de voz
                        const textLower = newText.toLowerCase();
                        
                        // Patrón para "Luz" (pregunta)
                        const luzPattern = /(?:^|\s|[.,;!?])\s*luz\s*(?:[.,;!?]|\s|$)/i;
                        const containsLuzCommand = luzPattern.test(textLower);
                        
                        // Patrón para "Toc toc" (explicación) - Simplificado
                        const containsTocCommand = textLower.includes('toc') || textLower.includes('tok');
                        
                        console.log("¿Contiene Luz?", containsLuzCommand);
                        console.log("¿Contiene Toc?", containsTocCommand);
                        
                        // Patrón para "Analiza" (análisis de documento)
                        const analizaPattern = /(?:^|\s|[.,;!?])\s*analiza\s*(?:[.,;!?]|\s|$)/i;
                        const containsAnalizaCommand = textLower.includes('analiza');
                        
                        if ((containsLuzCommand || containsTocCommand || containsAnalizaCommand) && !isProcessingQuestion) {
                            isProcessingQuestion = true;
                            
                            if (containsLuzCommand && !containsTocCommand && !containsAnalizaCommand) {
                                updateStatus("🎯 Comando 'Luz' detectado - Generando pregunta inteligente...");
                                
                                // Limpiar comando de la transcripción
                                const textWithoutCommand = newText.replace(/(?:^|\s|[.,;!?])\s*luz\s*(?:[.,;!?]|\s|$)/gi, ' ').trim();
                                if (textWithoutCommand) {
                                    if (fullTranscription) {
                                        fullTranscription += " " + textWithoutCommand;
                                    } else {
                                        fullTranscription = textWithoutCommand;
                                    }
                                }
                                
                                // Generar pregunta
                                try {
                                    const question = await generateIntelligentQuestion();
                                    responseArea.value = question;
                                    await makeAvatarSpeak(question);
                                    updateStatus("✅ Pregunta realizada - Continuando escucha", 'listening');
                                } catch (error) {
                                    console.error('Error al generar pregunta:', error);
                                    updateStatus("Error al generar pregunta", 'error');
                                }
                                
                            } else if (containsTocCommand && !containsAnalizaCommand) {
                                updateStatus("🎯 Comando 'Toc toc' detectado - Generando explicación...");
                                console.log("Procesando comando Toc toc...");
                                
                                // Limpiar comando de la transcripción
                                const textWithoutCommand = newText.replace(/toc|tok/gi, '').trim();
                                if (textWithoutCommand) {
                                    if (fullTranscription) {
                                        fullTranscription += " " + textWithoutCommand;
                                    } else {
                                        fullTranscription = textWithoutCommand;
                                    }
                                }
                                
                                // Generar explicación
                                try {
                                    console.log("Llamando a generateIntelligentExplanation...");
                                    const explanation = await generateIntelligentExplanation();
                                    console.log("Explicación generada:", explanation);
                                    responseArea.value = explanation;
                                    await makeAvatarSpeak(explanation);
                                    updateStatus("✅ Explicación proporcionada - Continuando escucha", 'listening');
                                } catch (error) {
                                    console.error('Error al generar explicación:', error);
                                    updateStatus("Error al generar explicación", 'error');
                                }
                                
                            } else if (containsAnalizaCommand) {
                                updateStatus("🎯 Comando 'Analiza' detectado - Analizando documento...");
                                console.log("Procesando comando Analiza...");
                                
                                // Limpiar comando de la transcripción
                                const textWithoutCommand = newText.replace(/analiza/gi, '').trim();
                                if (textWithoutCommand) {
                                    if (fullTranscription) {
                                        fullTranscription += " " + textWithoutCommand;
                                    } else {
                                        fullTranscription = textWithoutCommand;
                                    }
                                }
                                
                                // Generar análisis de documento
                                try {
                                    console.log("Llamando a generateDocumentAnalysis...");
                                    const analysis = await generateDocumentAnalysis();
                                    console.log("Análisis generado:", analysis);
                                    responseArea.value = analysis;
                                    await makeAvatarSpeak(analysis);
                                    updateStatus("✅ Análisis completado - Continuando escucha", 'listening');
                                } catch (error) {
                                    console.error('Error al generar análisis:', error);
                                    updateStatus("Error al generar análisis", 'error');
                                }
                            }
                            
                            isProcessingQuestion = false;
                            
                        } else {
                            // Texto normal - agregar a transcripción completa
                            if (fullTranscription) {
                                fullTranscription += " " + newText;
                            } else {
                                fullTranscription = newText;
                            }
                            
                            // Actualizar display
                            transcriptionArea.value = fullTranscription;
                            transcriptionArea.scrollTop = transcriptionArea.scrollHeight;
                            updateWordCount();
                            
                            console.log("Transcrito:", newText);
                            console.log("Transcripción completa tiene", fullTranscription.split(' ').length, "palabras");
                        }
                    }
                };

                return true;
            } catch (error) {
                console.error('Error al inicializar reconocimiento:', error);
                return false;
            }
        }

        // Hacer hablar al avatar
        async function makeAvatarSpeak(text) {
            return new Promise((resolve, reject) => {
                const spokenSsml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='es-CO'><voice name='${config.ttsVoice}'>${htmlEncode(text)}</voice></speak>`;
                
                updateStatus("🗣️ Avatar hablando...");
                
                avatarSynthesizer.speakSsmlAsync(spokenSsml).then((result) => {
                    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                        console.log("✅ Avatar habló correctamente");
                        updateStatus("🎧 Escuchando presentación...", 'listening');
                        resolve();
                    } else {
                        console.log("❌ Error en síntesis:", result.reason);
                        reject(new Error("Error en síntesis"));
                    }
                }).catch(error => {
                    console.log("❌ Error en avatar:", error);
                    reject(error);
                });
            });
        }

        // Iniciar escucha continua
        function startContinuousListening() {
            if (!continuousRecognizer || isListening) return;
            
            try {
                continuousRecognizer.startContinuousRecognitionAsync(() => {
                    isListening = true;
                    askQuestionBtn.disabled = false;
                    generateExplanationBtn.disabled = false;
                    updateListeningIndicator(true);
                    updateStatus("🎧 Escuchando presentación...", 'listening');
                    console.log("✅ Escucha continua iniciada");
                }, (err) => {
                    console.error('Error al iniciar escucha:', err);
                    updateStatus("Error al iniciar escucha", 'error');
                });
            } catch (error) {
                console.error('Error al iniciar escucha:', error);
            }
        }

        // Detener escucha
        function stopContinuousListening() {
            if (!continuousRecognizer || !isListening) return;
            
            try {
                continuousRecognizer.stopContinuousRecognitionAsync(() => {
                    isListening = false;
                    updateListeningIndicator(false);
                    console.log("✅ Escucha detenida");
                }, (err) => {
                    console.error('Error al detener escucha:', err);
                });
            } catch (error) {
                console.error('Error al detener escucha:', error);
            }
        }

        // Generar y hacer pregunta (función para botón)
        async function askIntelligentQuestion() {
            try {
                askQuestionBtn.disabled = true;
                updateStatus("🧠 Generando pregunta inteligente...");
                
                const question = await generateIntelligentQuestion();
                responseArea.value = question;
                
                await makeAvatarSpeak(question);
                
                askQuestionBtn.disabled = false;
                updateStatus("✅ Pregunta realizada - Continuando escucha", 'listening');
                
            } catch (error) {
                console.error('Error al generar pregunta:', error);
                updateStatus("Error al generar pregunta", 'error');
                askQuestionBtn.disabled = false;
            }
        }

        // Generar y hacer explicación (función para botón)
        async function generateExplanationManually() {
            try {
                generateExplanationBtn.disabled = true;
                updateStatus("🧠 Generando explicación detallada...");
                
                const explanation = await generateIntelligentExplanation();
                responseArea.value = explanation;
                
                await makeAvatarSpeak(explanation);
                
                generateExplanationBtn.disabled = false;
                updateStatus("✅ Explicación proporcionada - Continuando escucha", 'listening');
                
            } catch (error) {
                console.error('Error al generar explicación:', error);
                updateStatus("Error al generar explicación", 'error');
                generateExplanationBtn.disabled = false;
            }
        }

        // Iniciar sesión
        async function startSession() {
            try {
                updateStatus("🚀 Inicializando avatar...");
                startSessionBtn.disabled = true;

                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.cogSvcSubKey, config.region);
                const avatarConfig = new SpeechSDK.AvatarConfig(config.avatarCharacter, config.avatarStyle);
                avatarSynthesizer = new SpeechSDK.AvatarSynthesizer(speechConfig, avatarConfig);

                if (!initializeContinuousRecognition()) {
                    throw new Error("No se pudo inicializar el reconocimiento de voz");
                }

                isSessionActive = true;
                stopSessionBtn.disabled = false;

                // Limpiar transcripción anterior
                fullTranscription = "";
                transcriptionArea.value = "";
                responseArea.value = "";
                updateWordCount();

                const xhr = new XMLHttpRequest();
                xhr.open("GET", `https://${config.region}.tts.speech.microsoft.com/cognitiveservices/avatar/relay/token/v1`);
                xhr.setRequestHeader("Ocp-Apim-Subscription-Key", config.cogSvcSubKey);
                xhr.addEventListener("readystatechange", function() {
                    if (this.readyState === 4) {
                        try {
                            const responseData = JSON.parse(this.responseText);
                            setupWebRTC(responseData.Urls[0], responseData.Username, responseData.Password);
                        } catch (error) {
                            updateStatus("Error al obtener credenciales: " + error.message, 'error');
                            startSessionBtn.disabled = false;
                        }
                    }
                });
                xhr.send();

            } catch (error) {
                updateStatus("Error al iniciar: " + error.message, 'error');
                startSessionBtn.disabled = false;
            }
        }

        // Detener sesión
        function stopSession() {
            stopContinuousListening();
            
            if (avatarSynthesizer) {
                avatarSynthesizer.close();
            }
            
            isSessionActive = false;
            startSessionBtn.disabled = false;
            stopSessionBtn.disabled = true;
            askQuestionBtn.disabled = true;
            generateExplanationBtn.disabled = true;
            
            updateStatus("🔴 Sesión finalizada");
            updateListeningIndicator(false);
            
            // Mostrar resumen final
            if (fullTranscription) {
                const words = fullTranscription.trim().split(/\s+/).filter(word => word.length > 0);
                responseArea.value = `Sesión finalizada. Se transcribieron ${words.length} palabras sobre la Estrategia de Transformación Digital de la Fiscalía.`;
            }
        }

        // Event listeners
        startSessionBtn.addEventListener('click', startSession);
        stopSessionBtn.addEventListener('click', stopSession);
        askQuestionBtn.addEventListener('click', askIntelligentQuestion);
        generateExplanationBtn.addEventListener('click', generateExplanationManually);
        documentsBtn.addEventListener('click', openDocumentsModal);

        // Event listeners del modal
        closeModal.addEventListener('click', closeDocumentsModal);
        documentsModal.addEventListener('click', (e) => {
            if (e.target === documentsModal) closeDocumentsModal();
        });

        // Event listeners para subida de archivos
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Manejar archivos subidos
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type === 'application/pdf' || file.type === 'text/plain') {
                    if (file.size < 10 * 1024 * 1024) { // Límite 10MB
                        processUploadedFile(file);
                    } else {
                        updateStatus(`❌ Archivo "${file.name}" muy grande (máx 10MB)`, 'error');
                    }
                } else {
                    updateStatus(`❌ Tipo de archivo no soportado: ${file.name}`, 'error');
                }
            });
        }

        // Inicialización
        updateStatus("💡 Luz está lista - Presione 'Iniciar Avatar' para comenzar");
    </script>
</body>
</html>
