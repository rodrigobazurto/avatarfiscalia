<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Avatar Virtual - Fiscalía General de la Nación</title>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003f7f 0%, #0056b3 100%);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #ffd700;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 3.2em;
            margin-bottom: 8px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: bold;
            letter-spacing: 3px;
        }

        .header .tagline {
            font-size: 1.1em;
            color: #ffd700;
            font-style: italic;
            font-weight: 500;
        }

        .main-container {
            display: flex;
            flex: 1;
            padding: 15px;
            gap: 15px;
            min-height: 0;
        }

        .avatar-section {
            flex: 3.5;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #videoContainer {
            width: 100%;
            height: calc(100% - 160px);
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            min-height: 500px;
        }

        #remoteVideo video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 13px;
        }

        .control-panel {
            height: 145px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .controls-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
            min-width: 300px;
        }

        .transcription-box, .response-box {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .transcription-box h3, .response-box h3 {
            margin-bottom: 8px;
            color: #ffd700;
            font-size: 0.85em;
            font-weight: bold;
        }

        .response-box h3 {
            color: #87CEEB;
        }

        textarea {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 8px;
            color: white;
            font-size: 11px;
            font-family: 'Segoe UI', sans-serif;
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }

        textarea::placeholder {
            color: rgba(255,255,255,0.6);
        }

        textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .button {
            background: linear-gradient(45deg, #0056b3, #003f7f);
            border: none;
            color: white;
            padding: 12px 20px;
            margin: 3px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(0, 86, 179, 0.3);
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 86, 179, 0.4);
            background: linear-gradient(45deg, #0066cc, #004499);
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .button.stop {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 3px 12px rgba(244, 67, 54, 0.3);
        }

        .button.stop:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .button.question {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            box-shadow: 0 3px 12px rgba(33, 150, 243, 0.3);
        }

        .button.question:hover:not(:disabled) {
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .status {
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            border-left: 3px solid #ffd700;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
        }

        .status.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .status.listening {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .wake-word-info {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
            text-align: center;
            font-size: 11px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .wake-word-highlight {
            color: #ffd700;
            font-weight: bold;
            font-size: 13px;
        }

        .listening-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .footer {
            text-align: center;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            font-size: 11px;
            opacity: 0.8;
            flex-shrink: 0;
        }

        .button-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .word-count {
            font-size: 10px;
            color: rgba(255,255,255,0.7);
            text-align: right;
            margin-top: 4px;
        }

        /* Responsivo para pantallas más pequeñas */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .avatar-section {
                flex: 2;
                min-height: 400px;
            }
            
            .controls-section {
                flex: 1;
                flex-direction: row;
                max-width: none;
                min-height: 120px;
            }
            
            #videoContainer {
                height: calc(100% - 100px);
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Luz</h1>
        <p class="tagline">"La Justicia se ilumina con Inteligencia Artificial"</p>
    </div>

    <div class="main-container">
        <!-- Sección Avatar (Ocupa 80% del espacio) -->
        <div class="avatar-section">
            <div id="videoContainer">
                <div id="remoteVideo"></div>
                <canvas id="canvas" width="1920" height="1080" hidden></canvas>
                <canvas id="tmpCanvas" width="1920" height="1080" hidden></canvas>
            </div>
            
            <div class="control-panel">
                <div class="button-row">
                    <button id="startSession" class="button">🚀 Iniciar Avatar</button>
                    <button id="stopSession" class="button stop" disabled>⏹️ Finalizar</button>
                    <button id="askQuestion" class="button question" disabled>🤔 Pregunta IA</button>
                </div>
                
                <div class="wake-word-info">
                    <div>🎤 <span class="wake-word-highlight">Escuchando continuamente</span></div>
                    <small>Diga "Luz" para que la IA genere una pregunta</small>
                </div>
                
                <div id="status" class="status">Sistema listo. Presione 'Iniciar Avatar' para comenzar</div>
            </div>
        </div>

        <!-- Sección Transcripción y Respuesta (Compacta - 20%) -->
        <div class="controls-section">
            <div class="transcription-box">
                <h3><span id="listeningIndicator"></span>📝 Transcripción Completa</h3>
                <textarea id="transcription" readonly placeholder="Aquí se guardará todo lo que diga durante la presentación..."></textarea>
                <div id="wordCount" class="word-count">0 palabras</div>
            </div>

            <div class="response-box">
                <h3>🤖 Pregunta/Respuesta IA</h3>
                <textarea id="avatarResponse" readonly placeholder="El avatar generará preguntas inteligentes sobre su presentación..."></textarea>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>© 2025 Fiscalía General de la Nación - IA Conversacional Avanzada</p>
    </div>

    <script>
        // Configuración
        const config = {
            cogSvcSubKey: "1de1c13947f34b9fb1f4c4abfdf578a0",
            azureOpenAIEndpoint: "https://fgnfoundrylabo3874907599.openai.azure.com/",
            azureOpenAIApiKey: "1oSTnxg0CC9O4oIaB2a6POpWSvOIFxXP6qwR5QlgbDW2ve79fE7KJQQJ99BCACHYHv6XJ3w3AAAAACOGNk1S",
            azureOpenAIDeploymentName: "gpt-4.1",
            azureOpenAIApiVersion: "2024-02-15-preview",
            systemPrompt: `Eres un asistente IA especializado que escucha presentaciones sobre la Estrategia de Transformación Digital de la Fiscalía General de la Nación de Colombia.

TU FUNCIÓN PRINCIPAL:
- Analizar el contenido transcrito de la presentación de la Fiscal
- Generar preguntas inteligentes, relevantes y profesionales sobre lo expuesto
- Hacer preguntas que demuestren comprensión profunda del tema
- Solicitar aclaraciones sobre puntos específicos mencionados
- Preguntar sobre implementación práctica de los conceptos expuestos

CONOCIMIENTO BASE DE LA FISCALÍA:
- Direccionamiento Estratégico 2024-2028: "Experiencia e innovación al servicio de la justicia"
- 5 Pilares Estratégicos de transformación
- 6 Programas de Transformación Digital
- Proyectos clave: SPOA 2, SGDEA, expediente electrónico, laboratorio de innovación
- Marco normativo: Resolución 0412/2024

TIPOS DE PREGUNTAS A GENERAR:
1. Preguntas de profundización: "¿Podría explicar más sobre [tema específico mencionado]?"
2. Preguntas de implementación: "¿Cómo se implementará concretamente [proyecto mencionado]?"
3. Preguntas de integración: "¿Cómo se relaciona [tema A] con [tema B] que mencionó?"
4. Preguntas de impacto: "¿Cuál será el impacto específico de [iniciativa] en los fiscales?"
5. Preguntas de cronograma: "¿Cuáles son los tiempos estimados para [proyecto]?"

ESTILO DE PREGUNTAS:
- Formal pero conversacional
- Específicas basadas en lo realmente dicho
- Máximo 80 palabras por pregunta
- Una sola pregunta por vez
- Que demuestren escucha activa e inteligente
- Sin emojis en las preguntas

RESPONDE SOLO con la pregunta directa, sin preámbulos ni explicaciones adicionales.`,
            sttLocale: "es-CO",
            ttsVoice: "es-CO-SalomeNeural",
            avatarCharacter: "Meg",
            avatarStyle: "business",
            region: "westus2"
        };

        // Variables globales
        let avatarSynthesizer;
        let continuousRecognizer;
        let peerConnection;
        let isSessionActive = false;
        let isListening = false;
        let fullTranscription = ""; // Almacena toda la transcripción
        let lastSentenceCount = 0;
        let isProcessingQuestion = false; // Para evitar múltiples activaciones

        // Elementos DOM
        const startSessionBtn = document.getElementById('startSession');
        const stopSessionBtn = document.getElementById('stopSession');
        const askQuestionBtn = document.getElementById('askQuestion');
        const statusDiv = document.getElementById('status');
        const transcriptionArea = document.getElementById('transcription');
        const responseArea = document.getElementById('avatarResponse');
        const listeningIndicator = document.getElementById('listeningIndicator');
        const wordCountDiv = document.getElementById('wordCount');

        // Funciones de utilidad
        function updateStatus(message, type = 'normal') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateListeningIndicator(isActive) {
            listeningIndicator.innerHTML = isActive ? '<span class="listening-indicator"></span>' : '';
        }

        function updateWordCount() {
            const words = fullTranscription.trim().split(/\s+/).filter(word => word.length > 0);
            wordCountDiv.textContent = `${words.length} palabras`;
        }

        // Generar pregunta inteligente basada en la transcripción
        async function generateIntelligentQuestion() {
            if (!fullTranscription.trim()) {
                return "Señora Fiscal, estoy lista para escuchar su presentación sobre la Estrategia de Transformación Digital de la Fiscalía.";
            }

            try {
                updateStatus("🧠 Analizando presentación y generando pregunta...");
                
                const response = await fetch(`${config.azureOpenAIEndpoint}openai/deployments/${config.azureOpenAIDeploymentName}/chat/completions?api-version=${config.azureOpenAIApiVersion}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': config.azureOpenAIApiKey
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: config.systemPrompt },
                            { role: "user", content: `Analiza esta transcripción de la presentación de la Fiscal y genera UNA pregunta inteligente y específica basada en lo que ha expuesto:\n\n"${fullTranscription}"` }
                        ],
                        max_tokens: 150,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('Error OpenAI:', error);
                return "Disculpe, Señora Fiscal, ¿podría repetir el último punto que mencionó?";
            }
        }

        // Codificar HTML
        function htmlEncode(text) {
            const entityMap = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
                "'": '&#39;', '/': '&#x2F;'
            };
            return String(text).replace(/[&<>"'\/]/g, (match) => entityMap[match]);
        }

        // Setup WebRTC
        function setupWebRTC(iceServerUrl, iceServerUsername, iceServerCredential) {
            peerConnection = new RTCPeerConnection({
                iceServers: [{
                    urls: [iceServerUrl],
                    username: iceServerUsername,
                    credential: iceServerCredential
                }]
            });

            peerConnection.ontrack = function (event) {
                const remoteVideoDiv = document.getElementById('remoteVideo');
                for (let i = 0; i < remoteVideoDiv.childNodes.length; i++) {
                    if (remoteVideoDiv.childNodes[i].localName === event.track.kind) {
                        remoteVideoDiv.removeChild(remoteVideoDiv.childNodes[i]);
                    }
                }

                const mediaPlayer = document.createElement(event.track.kind);
                mediaPlayer.id = event.track.kind;
                mediaPlayer.srcObject = event.streams[0];
                mediaPlayer.autoplay = true;
                document.getElementById('remoteVideo').appendChild(mediaPlayer);

                if (event.track.kind === 'video') {
                    mediaPlayer.playsInline = true;
                } else {
                    mediaPlayer.muted = false;
                }
            };

            peerConnection.oniceconnectionstatechange = e => {
                if (peerConnection.iceConnectionState === 'connected') {
                    updateStatus("✅ Avatar conectado - Comenzando escucha automática");
                    
                    setTimeout(() => {
                        const welcomeMessage = "Buenos días, Señora Fiscal. Soy Luz, su asistente de inteligencia artificial especializado en Transformación Digital de la Fiscalía General de la Nación. Estoy lista para escuchar su presentación. Cuando desee que le haga una pregunta inteligente, simplemente diga mi nombre: Luz.";
                        responseArea.value = welcomeMessage;
                        makeAvatarSpeak(welcomeMessage).then(() => {
                            startContinuousListening();
                        });
                    }, 2000);
                }

                if (peerConnection.iceConnectionState === 'disconnected' || peerConnection.iceConnectionState === 'failed') {
                    updateStatus("❌ Conexión perdida", 'error');
                    stopSession();
                }
            };

            peerConnection.addTransceiver('video', { direction: 'sendrecv' });
            peerConnection.addTransceiver('audio', { direction: 'sendrecv' });

            avatarSynthesizer.startAvatarAsync(peerConnection).then((r) => {
                if (r.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                    updateStatus("🎤 Avatar listo - Iniciando modo escucha");
                } else {
                    updateStatus("Error al iniciar avatar", 'error');
                    startSessionBtn.disabled = false;
                }
            }).catch((error) => {
                updateStatus("Error al iniciar avatar: " + error, 'error');
                startSessionBtn.disabled = false;
            });
        }

        // Inicializar reconocimiento continuo
        function initializeContinuousRecognition() {
            try {
                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.cogSvcSubKey, config.region);
                speechConfig.speechRecognitionLanguage = config.sttLocale;
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                continuousRecognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

                // Reconocimiento en tiempo real
                continuousRecognizer.recognizing = (s, e) => {
                    if (e.result.text.trim()) {
                        // Mostrar texto temporal en transcripción
                        transcriptionArea.value = fullTranscription + "\n[Escuchando: " + e.result.text + "]";
                        transcriptionArea.scrollTop = transcriptionArea.scrollHeight;
                    }
                };

                // Reconocimiento finalizado - agregar a transcripción completa
                continuousRecognizer.recognized = async (s, e) => {
                    if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech && e.result.text.trim()) {
                        const newText = e.result.text.trim();
                        
                        // Verificar si contiene la palabra clave "Luz"
                        const containsLuz = newText.toLowerCase().includes('luz');
                        
                        if (containsLuz && !isProcessingQuestion) {
                            // Activación por palabra clave Luz detectada
                            isProcessingQuestion = true;
                            updateStatus("🎯 Palabra clave Luz detectada - Generando pregunta inteligente...");
                            
                            // No agregar "Luz" a la transcripción, solo el contexto útil
                            const textWithoutLuz = newText.replace(/\bluz\b/gi, '').trim();
                            if (textWithoutLuz) {
                                if (fullTranscription) {
                                    fullTranscription += " " + textWithoutLuz;
                                } else {
                                    fullTranscription = textWithoutLuz;
                                }
                            }
                            
                            // Generar y hacer pregunta automáticamente
                            try {
                                const question = await generateIntelligentQuestion();
                                responseArea.value = question;
                                await makeAvatarSpeak(question);
                                updateStatus("✅ Pregunta realizada - Continuando escucha", 'listening');
                            } catch (error) {
                                console.error('Error al generar pregunta automática:', error);
                                updateStatus("Error al generar pregunta", 'error');
                            }
                            
                            isProcessingQuestion = false;
                            
                        } else if (!containsLuz) {
                            // Texto normal - agregar a transcripción completa
                            if (fullTranscription) {
                                fullTranscription += " " + newText;
                            } else {
                                fullTranscription = newText;
                            }
                            
                            // Actualizar display
                            transcriptionArea.value = fullTranscription;
                            transcriptionArea.scrollTop = transcriptionArea.scrollHeight;
                            updateWordCount();
                            
                            console.log("Transcrito:", newText);
                            console.log("Transcripción completa tiene", fullTranscription.split(' ').length, "palabras");
                        }
                    }
                };

                return true;
            } catch (error) {
                console.error('Error al inicializar reconocimiento:', error);
                return false;
            }
        }

        // Hacer hablar al avatar
        async function makeAvatarSpeak(text) {
            return new Promise((resolve, reject) => {
                const spokenSsml = `<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='es-CO'><voice name='${config.ttsVoice}'>${htmlEncode(text)}</voice></speak>`;
                
                updateStatus("🗣️ Avatar hablando...");
                
                avatarSynthesizer.speakSsmlAsync(spokenSsml).then((result) => {
                    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                        console.log("✅ Avatar habló correctamente");
                        updateStatus("🎧 Escuchando presentación...", 'listening');
                        resolve();
                    } else {
                        console.log("❌ Error en síntesis:", result.reason);
                        reject(new Error("Error en síntesis"));
                    }
                }).catch(error => {
                    console.log("❌ Error en avatar:", error);
                    reject(error);
                });
            });
        }

        // Iniciar escucha continua
        function startContinuousListening() {
            if (!continuousRecognizer || isListening) return;
            
            try {
                continuousRecognizer.startContinuousRecognitionAsync(() => {
                    isListening = true;
                    askQuestionBtn.disabled = false;
                    updateListeningIndicator(true);
                    updateStatus("🎧 Escuchando presentación...", 'listening');
                    console.log("✅ Escucha continua iniciada");
                }, (err) => {
                    console.error('Error al iniciar escucha:', err);
                    updateStatus("Error al iniciar escucha", 'error');
                });
            } catch (error) {
                console.error('Error al iniciar escucha:', error);
            }
        }

        // Detener escucha
        function stopContinuousListening() {
            if (!continuousRecognizer || !isListening) return;
            
            try {
                continuousRecognizer.stopContinuousRecognitionAsync(() => {
                    isListening = false;
                    updateListeningIndicator(false);
                    console.log("✅ Escucha detenida");
                }, (err) => {
                    console.error('Error al detener escucha:', err);
                });
            } catch (error) {
                console.error('Error al detener escucha:', error);
            }
        }

        // Generar y hacer pregunta
        async function askIntelligentQuestion() {
            try {
                askQuestionBtn.disabled = true;
                
                const question = await generateIntelligentQuestion();
                responseArea.value = question;
                
                await makeAvatarSpeak(question);
                
                askQuestionBtn.disabled = false;
                
            } catch (error) {
                console.error('Error al generar pregunta:', error);
                updateStatus("Error al generar pregunta", 'error');
                askQuestionBtn.disabled = false;
            }
        }

        // Iniciar sesión
        async function startSession() {
            try {
                updateStatus("🚀 Inicializando avatar...");
                startSessionBtn.disabled = true;

                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.cogSvcSubKey, config.region);
                const avatarConfig = new SpeechSDK.AvatarConfig(config.avatarCharacter, config.avatarStyle);
                avatarSynthesizer = new SpeechSDK.AvatarSynthesizer(speechConfig, avatarConfig);

                if (!initializeContinuousRecognition()) {
                    throw new Error("No se pudo inicializar el reconocimiento de voz");
                }

                isSessionActive = true;
                stopSessionBtn.disabled = false;

                // Limpiar transcripción anterior
                fullTranscription = "";
                transcriptionArea.value = "";
                responseArea.value = "";
                updateWordCount();

                const xhr = new XMLHttpRequest();
                xhr.open("GET", `https://${config.region}.tts.speech.microsoft.com/cognitiveservices/avatar/relay/token/v1`);
                xhr.setRequestHeader("Ocp-Apim-Subscription-Key", config.cogSvcSubKey);
                xhr.addEventListener("readystatechange", function() {
                    if (this.readyState === 4) {
                        try {
                            const responseData = JSON.parse(this.responseText);
                            setupWebRTC(responseData.Urls[0], responseData.Username, responseData.Password);
                        } catch (error) {
                            updateStatus("Error al obtener credenciales: " + error.message, 'error');
                            startSessionBtn.disabled = false;
                        }
                    }
                });
                xhr.send();

            } catch (error) {
                updateStatus("Error al iniciar: " + error.message, 'error');
                startSessionBtn.disabled = false;
            }
        }

        // Detener sesión
        function stopSession() {
            stopContinuousListening();
            
            if (avatarSynthesizer) {
                avatarSynthesizer.close();
            }
            
            isSessionActive = false;
            startSessionBtn.disabled = false;
            stopSessionBtn.disabled = true;
            askQuestionBtn.disabled = true;
            
            updateStatus("🔴 Sesión finalizada");
            updateListeningIndicator(false);
            
            // Mostrar resumen final
            if (fullTranscription) {
                const words = fullTranscription.trim().split(/\s+/).filter(word => wor
